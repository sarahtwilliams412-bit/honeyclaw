version: "3.8"

# HoneyClaw Enterprise Simulation - Hardened Docker Compose
# Multi-service honeypot with network isolation, AppArmor, Seccomp, and resource limits.

services:
  honeypot-enterprise:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: honeyclaw-enterprise
    restart: unless-stopped

    # Security hardening
    read_only: true
    security_opt:
      - no-new-privileges:true
      - apparmor=honeyclaw-enterprise
      - seccomp=../../deploy/seccomp/honeyclaw-enterprise.json
    cap_drop:
      - ALL
    cap_add:
      # Minimal capabilities needed by multi-service enterprise sim
      - NET_BIND_SERVICE  # bind to ports < 1024 (22, 80, 443, 389, 445)
      - CHOWN             # supervisor needs to chown pid files
      - SETGID            # services need to drop to service accounts
      - SETUID            # services need to drop to service accounts
      - DAC_OVERRIDE      # supervisor needs to access service configs
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
      - /run:noexec,nosuid,size=16m
      - /var/run:noexec,nosuid,size=16m

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
          pids: 100
        reservations:
          cpus: "0.2"
          memory: 256M

    # Network - isolated honeypot network only
    networks:
      - honeyclaw-isolated

    # Ports - multi-service
    ports:
      - "${HONEYCLAW_SSH_PORT:-22}:22"
      - "${HONEYCLAW_HTTP_PORT:-80}:80"
      - "${HONEYCLAW_HTTPS_PORT:-443}:443"
      - "${HONEYCLAW_RDP_PORT:-3389}:3389"
      - "${HONEYCLAW_WINRM_PORT:-5985}:5985"
      - "${HONEYCLAW_SMB_PORT:-445}:445"
      - "${HONEYCLAW_LDAP_PORT:-389}:389"

    # Volumes - only logs are writable
    volumes:
      - enterprise-logs:/var/log/honeypot
      - enterprise-samba:/var/lib/samba
      - enterprise-supervisor:/var/log/supervisor

    # Environment
    environment:
      - HONEYPOT_ID=${HONEYPOT_ID:-enterprise-default}
      - HONEYPOT_TEMPLATE=enterprise-sim
      - S3_BUCKET=${HONEYCLAW_S3_BUCKET:-}
      - S3_ENDPOINT=${HONEYCLAW_S3_ENDPOINT:-}
      - SIEM_ENABLED=${SIEM_ENABLED:-false}
      - SIEM_PROVIDER=${SIEM_PROVIDER:-}
      - SIEM_ENDPOINT=${SIEM_ENDPOINT:-}
      - SIEM_TOKEN=${SIEM_TOKEN:-}
      - ALERT_WEBHOOK_URL=${ALERT_WEBHOOK_URL:-}
      - ALERT_SEVERITY_THRESHOLD=${ALERT_SEVERITY_THRESHOLD:-MEDIUM}

    # Labels
    labels:
      honeyclaw.template: enterprise-sim
      honeyclaw.interaction: high
      honeyclaw.isolation: strict

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  honeyclaw-isolated:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "false"
      com.docker.network.bridge.enable_ip_masquerade: "false"
    internal: true

volumes:
  enterprise-logs:
    driver: local
  enterprise-samba:
    driver: local
  enterprise-supervisor:
    driver: local
